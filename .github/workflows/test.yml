name: Test Suite - Optimized CI Execution

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:  # Allow manual triggering

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      # Python optimizations
      PYTHONUNBUFFERED: 1
      PYTHONDONTWRITEBYTECODE: 1
      # CI Environment indicator
      CI: true
      GITHUB_ACTIONS: true
      # Browser configuration for CI
      BROWSER_HEADLESS: true
      BROWSER_CI_MODE: true
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-3.11-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-3.11-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Set up Chrome browser
      uses: browser-actions/setup-chrome@v1
      with:
        chrome-version: stable
    
    - name: Cache Chrome and WebDriver binaries
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/selenium
          ~/.wdm
          ~/.cache/ms-playwright
        key: ${{ runner.os }}-browsers-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-browsers-
    
    - name: Create reports directory
      run: mkdir -p reports
    
    - name: Verify Chrome installation
      run: |
        echo "üîç Verifying Chrome installation..."
        google-chrome --version || chrome --version || chromium --version
        echo "üîç Chrome installation verified"
    
    - name: Verify test collection
      run: |
        echo "üîç Verifying test collection..."
        timeout 30 pytest tests/ --collect-only -q --tb=no || echo "‚ö†Ô∏è Collection verification failed, continuing with tests..."
        echo "‚úÖ Test collection verification completed"
    
    - name: Run unit tests with coverage
      run: |
        echo "üß™ Starting Unit Tests..."
        timeout 180 pytest tests/unit/ -v --cov=utils --cov-report=xml --cov-report=term-missing --cov-report=html:reports/coverage
        echo "‚úÖ Unit tests completed"
    
    - name: Run API tests
      run: |
        echo "üß™ Starting API Tests..."
        timeout 180 pytest tests/api/ -v --html=reports/api-report.html --self-contained-html
        echo "‚úÖ API tests completed"
    
    - name: Run E2E tests (optimized for CI)
      run: |
        echo "üß™ Starting E2E Tests (CI optimized)..."
        echo "üöÄ Running with CI-optimized settings..."
        timeout 600 pytest tests/e2e/ -v --html=reports/e2e-report.html --self-contained-html -x --tb=short
        echo "‚úÖ E2E tests completed"
      timeout-minutes: 12
    
    - name: Generate final test report
      run: |
        echo "üìä Generating comprehensive test report..."
        echo "‚úÖ All test stages completed successfully"
    
    - name: Upload test reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-reports
        path: |
          reports/
          .coverage
          coverage.xml
        retention-days: 30

  lint:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install linting tools
      run: |
        pip install black flake8 isort
    
    # - name: Run Black (code formatting check)
    #   run: |
    #     echo "üîç Checking code formatting with Black..."
    #     black --check --diff .
    #
    # - name: Run isort (import sorting check)
    #   run: |
    #     echo "üîç Checking import sorting with isort..."
    #     isort --check-only --diff .
    
    - name: Run Flake8 (linting)
      run: |
        echo "üîç Running Flake8 linting..."
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics 